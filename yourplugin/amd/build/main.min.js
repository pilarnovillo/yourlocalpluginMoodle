define("local_yourplugin/main",["jquery","core/log","core/ajax"],(function($,log,ajax){return log.debug("Your module is loading2."),{init:function(datos_json){$(document).ready((function(){var datos=JSON.parse(datos_json);log.debug(datos);var rasAsignaturaArray=[];log.debug("CHECK IF DRAFT SAVED");var queryString=window.location.search,params=(queryString=queryString.substring(1)).split("&"),paramsObject={};params.forEach((function(param){var keyValue=param.split("="),key=decodeURIComponent(keyValue[0]),value=decodeURIComponent(keyValue[1]);paramsObject[key]=value}));var paramCourseid=paramsObject.courseid;log.debug(paramCourseid);var resultadoAprendizajeOA={raasignatura:[],verbo:"",objeto:"",condicion:"",finalidad:""},selectedTopics=[],seleccionarUnidadTitulo=document.createElement("h3");seleccionarUnidadTitulo.textContent="Seleccionar Unidad y Topicos:";var defaultOption=document.createElement("option");defaultOption.text="Seleccione una opción",defaultOption.value="",defaultOption.disabled=!0,defaultOption.selected=!0;var select=document.createElement("select");select.setAttribute("id","id_unidadSelect"),select.appendChild(defaultOption);var unidadesConTemasYTopicos=function(datos){let unidadesConTemasYTopicos=[];for(const asignaturaUri in datos){const asignatura=datos[asignaturaUri];for(const raasignatura in asignatura.RAsAsignatura)rasAsignaturaArray.push(raasignatura);for(const contenidoUri in asignatura.contenidosMinimo){const contenido=asignatura.contenidosMinimo[contenidoUri];for(const unidadUri in contenido.unidades){const unidad=contenido.unidades[unidadUri];let temasYTopicos=[];for(const temaUri in unidad.temas){let topicos=[],topicosYsubs=[];const tema=unidad.temas[temaUri];for(const topicoUri in tema.topicos){let partes=[];const topico=tema.topicos[topicoUri];for(const parteUri in topico.partes)partes.push(parteUri.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#",""));topicos.push(topicoUri.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#","")),topicosYsubs.push({topico:topicoUri,partes:partes})}temasYTopicos.push({tema:temaUri.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#",""),topicos:topicos,topicosYsubs:topicosYsubs})}unidadesConTemasYTopicos.push({unidad:unidadUri.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#",""),temasYTopicos:temasYTopicos})}}}return unidadesConTemasYTopicos}(datos),temasTopicosDic={};unidadesConTemasYTopicos.forEach((function(unidadConTemasYTopicos){var option=document.createElement("option");option.textContent=unidadConTemasYTopicos.unidad,option.value=unidadConTemasYTopicos.unidad.toUpperCase().replace(/\s+/g,"_"),option.dataset.temasYTopicos=JSON.stringify(unidadConTemasYTopicos.temasYTopicos),select.appendChild(option);var i=1;unidadConTemasYTopicos.temasYTopicos.forEach((function(tema){tema.topicosYsubs.forEach((function(topico){temasTopicosDic[topico.topico.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#","").toUpperCase().replace(/\s+/g,"_")]={name:topico.topico.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#",""),order:i,incluido:{},parte:topico.partes,soporte:{}},i++}))}))}));var mainDiv=document.querySelector('div[role="main"]');mainDiv.insertBefore(seleccionarUnidadTitulo,mainDiv.firstChild),seleccionarUnidadTitulo.insertAdjacentElement("afterend",select);var ul=document.createElement("ul");ul.setAttribute("id","listaTemasYTopicos"),ul.style.listStyleType="none",select.insertAdjacentElement("afterend",ul),select.addEventListener("change",(function(event){var selectedOption=event.target.selectedOptions[0],temasYTopicos=JSON.parse(selectedOption.dataset.temasYTopicos);ul.innerHTML="",temasYTopicos.forEach((item=>{var liTema=document.createElement("li");liTema.textContent=item.tema,ul.appendChild(liTema),item.topicos.forEach((topico=>{var liTopico=document.createElement("li"),checkbox=document.createElement("input");checkbox.type="checkbox",checkbox.value=topico.toUpperCase().replace(/\s+/g,"_");var label=document.createElement("label");label.textContent=topico,label.prepend(checkbox),liTopico.appendChild(label),liTopico.style.marginLeft="20px",ul.appendChild(liTopico),checkbox.addEventListener("change",(function(event){if(event.target.checked){var tableRow={name:temasTopicosDic[event.target.value].name,order:temasTopicosDic[event.target.value].order,incluido:{},parte:temasTopicosDic[event.target.value].parte,ejemplos:"",actividades:"Definición de límite - Actividad 1"},select=document.getElementById("menutopic"),option=document.createElement("option");option.textContent=temasTopicosDic[event.target.value].name,option.value=event.target.value,select.appendChild(option),fillTable(tableRow,event.target.value)}else{removeItemFromTable(event.target.value),removeOptionByValue(select=document.getElementById("menutopic"),event.target.value)}}))}))}))}));var seleccionarRAsTitulo=document.createElement("h3");seleccionarRAsTitulo.textContent="Seleccionar Resultados de Aprendizaje de la Asignatura:";var checkboxesContainer=document.createElement("div");checkboxesContainer.setAttribute("id","resultadoAprendizaje");var resultadosAprendizaje=rasAsignaturaArray;log.debug("resultadosAprendizaje: "+resultadosAprendizaje),resultadosAprendizaje.forEach((function(raText){raText=raText.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#","");var checkbox=document.createElement("input");checkbox.type="checkbox",checkbox.value=raText;var label=document.createElement("label");label.textContent=raText,label.appendChild(checkbox),checkboxesContainer.appendChild(label);var br=document.createElement("br");checkboxesContainer.appendChild(br),checkbox.addEventListener("change",(function(event){if(event.target.checked)resultadoAprendizajeOA.raasignatura.push(event.target.value);else for(let i=resultadoAprendizajeOA.raasignatura.length-1;i>=0;i--)resultadoAprendizajeOA.raasignatura[i]===event.target.value&&resultadoAprendizajeOA.raasignatura.splice(i,1)}))})),ul.insertAdjacentElement("afterend",seleccionarRAsTitulo),seleccionarRAsTitulo.insertAdjacentElement("afterend",checkboxesContainer);var title=document.createElement("h3");title.textContent="Definir el resultado de aprendizaje del Objeto de Aprendizaje";var verboInput=createTextInput("Verbo:"),objetoConocimientoInput=createTextInput("Objeto de Conocimiento:"),condicionInput=createTextInput("Condición:"),finalidadInput=createTextInput("Finalidad:");checkboxesContainer.insertAdjacentElement("afterend",title),title.insertAdjacentElement("afterend",verboInput),verboInput.insertAdjacentElement("afterend",objetoConocimientoInput),objetoConocimientoInput.insertAdjacentElement("afterend",condicionInput),condicionInput.insertAdjacentElement("afterend",finalidadInput);function createTextInput(labelText){var container=document.createElement("div"),label=document.createElement("label");label.textContent=labelText;var input=document.createElement("input");return input.setAttribute("type","text"),container.appendChild(label),container.appendChild(input),container}verboInput.addEventListener("change",(async function(event){log.debug("Input VERBO value changed:",event.target.value),resultadoAprendizajeOA.verbo=event.target.value;const id=paramsObject.oaid,name=event.target.value,response=await((id,name)=>ajax.call([{methodname:"local_yourplugin_store_oa_fields",args:{id:id,name:name}}])[0])(id,name);log.debug(response);const responseVerbLevel=await(raasignatura="RAAsignatura",verbo=name,ajax.call([{methodname:"local_yourplugin_verify_verb_level",args:{raasignatura:raasignatura,verbo:verbo}}])[0]);var raasignatura,verbo;log.debug(responseVerbLevel)})),async function(){const id=paramsObject.oaid;try{const response=await(async id=>(await ajax.call([{methodname:"local_yourplugin_get_oa_fields",args:{id:id}}]))[0])(id);log.debug(response[0].name);var storedName=response[0].name;if("empty name"!=storedName){verboInput.querySelector("input").value=storedName;var selectUnidad=document.getElementById("id_unidadSelect");const getOATopicsFromOntology=oaid=>ajax.call([{methodname:"local_yourplugin_get_oa_topics",args:{oaid:oaid}}])[0];var topicosOntologia=[];try{const responseOATopicsFromOntology=await getOATopicsFromOntology(paramsObject.oaid);log.debug("Getting topics:"),log.debug(responseOATopicsFromOntology),responseOATopicsFromOntology.forEach((topico=>{var valueTopico=topico.topic.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#","");topicosOntologia.push(valueTopico)}))}catch(error){log.debug("Error fetching OA Topicos: ",error),log.debug(error)}var selectedOption=Array.from(selectUnidad.options).find((option=>"MADUNIDAD1"===option.value));selectUnidad.value=selectedOption.value;var temasYTopicos=JSON.parse(selectedOption.dataset.temasYTopicos);ul.innerHTML="",temasYTopicos.forEach((item=>{var liTema=document.createElement("li");liTema.textContent=item.tema,ul.appendChild(liTema),item.topicos.forEach((topico=>{var liTopico=document.createElement("li"),checkbox=document.createElement("input");checkbox.type="checkbox",checkbox.value=topico.toUpperCase().replace(/\s+/g,"_");var label=document.createElement("label");if(label.textContent=topico,label.prepend(checkbox),liTopico.appendChild(label),liTopico.style.marginLeft="20px",ul.appendChild(liTopico),topicosOntologia.includes(checkbox.value)){checkbox.checked=!0;var tableRow={name:temasTopicosDic[checkbox.value].name,order:temasTopicosDic[checkbox.value].order,incluido:{},parte:temasTopicosDic[checkbox.value].parte,ejemplos:"",actividades:"Definición de límite - Actividad 1"},select=document.getElementById("menutopic"),option=document.createElement("option");option.textContent=temasTopicosDic[checkbox.value].name,option.value=checkbox.value,select.appendChild(option),fillTable(tableRow,checkbox.value)}checkbox.addEventListener("change",(async function(event){const guardarTopicoOA=(idTopico,oaid,selected)=>ajax.call([{methodname:"local_yourplugin_guardar_topico_oa",args:{idTopico:idTopico,oaid:oaid,selected:selected}}])[0];if(event.target.checked){var tableRow={name:temasTopicosDic[event.target.value].name,order:temasTopicosDic[event.target.value].order,incluido:{},parte:temasTopicosDic[event.target.value].parte,ejemplos:"",actividades:"Definición de límite - Actividad 1"},select=document.getElementById("menutopic"),option=document.createElement("option");option.textContent=temasTopicosDic[event.target.value].name,option.value=event.target.value,select.appendChild(option),fillTable(tableRow,event.target.value);const response=await guardarTopicoOA(event.target.value,paramsObject.oaid,!0);log.debug(response)}else{removeItemFromTable(event.target.value),removeOptionByValue(select=document.getElementById("menutopic"),event.target.value);const response=await guardarTopicoOA(event.target.value,paramsObject.oaid,!1);log.debug(response)}}))}))}));const getOAFromOntology=id=>ajax.call([{methodname:"local_yourplugin_get_oa_ontology",args:{id:id}}])[0];try{(await getOAFromOntology(id)).forEach((ra=>{var valueRaAsig=ra.raasig.replace("http://www.semanticweb.org/valer/ontologies/OntoOA#","");document.querySelectorAll('#resultadoAprendizaje input[type="checkbox"][value="'.concat(valueRaAsig,'"]'))[0].checked=!0}))}catch(error){log.debug("Error fetching OA RAsAsig: ",error),log.debug(error)}}}catch(error){log.debug("Error fetching OA fields:",error)}}();var tablaTitulo=document.createElement("h3");tablaTitulo.textContent="Ordenar Topicos:",finalidadInput.insertAdjacentElement("afterend",tablaTitulo);var table=document.getElementsByClassName("generaltable")[0];table.id="editableTable";var thead=document.createElement("thead"),headerRow=document.createElement("tr");["","Tópico","Order","Tópico incluido","Orden Tópico incluido","Tópico Parte","Orden Tópico Parte","Ejemplos","Actividades"].forEach((function(headerText){var th=document.createElement("th");th.textContent=headerText,headerRow.appendChild(th)})),thead.appendChild(headerRow),table.appendChild(thead);var tbody=document.createElement("tbody");function removeItemFromTable(id){const row=tbody.querySelector('tr[id="'.concat(id,'"]'));row&&tbody.removeChild(row)}function removeOptionByValue(select,value){for(var options=select.options,i=0;i<options.length;i++)if(options[i].value===value){select.remove(i);break}}function fillTable(data,id){var row=document.createElement("tr");row.setAttribute("id",id),row.style.border="1px solid black";var dragHandleCell=document.createElement("td");dragHandleCell.className="drag-handle",dragHandleCell.textContent="☰",dragHandleCell.draggable=!0,row.appendChild(dragHandleCell),Object.keys(data).forEach((function(key){var td=document.createElement("td"),tdOrdenIncluido=document.createElement("td");if("incluido"===key){for(const incluido in data[key])if(data[key].hasOwnProperty(incluido)){var div=document.createElement("div");div.className="draggable",div.draggable=!0,div.textContent=incluido,td.appendChild(div);var divOrdenIncluido=document.createElement("div");divOrdenIncluido.className="draggable",divOrdenIncluido.draggable=!0,divOrdenIncluido.textContent=data[key][incluido],tdOrdenIncluido.appendChild(divOrdenIncluido)}row.appendChild(td),tdOrdenIncluido.style.border="1px solid black",row.appendChild(tdOrdenIncluido)}else td.textContent=data[key],row.appendChild(td);td.style.border="1px solid black"})),tbody.appendChild(row)}table.appendChild(tbody),table.addEventListener("click",(function(event){var target=event.target;if(target.classList.contains("editable")){var value=target.textContent,input=document.createElement("input");input.type="text",input.value=value,input.addEventListener("blur",(function(){var newValue=this.value;target.textContent=newValue})),target.textContent="",target.appendChild(input),input.focus()}}));var style=document.createElement("style");style.textContent="\n                    .drag-handle {\n                        cursor: grab;\n                    }\n                    .dragging {\n                        background-color: lightblue;\n                    }\n                    .draggable-container {\n                        display: flex;\n                        flex-direction: column;\n                    }\n                    .draggable {\n                        padding: 10px;\n                        border: 1px solid #ccc;\n                        background-color: #f9f9f9;\n                        margin-bottom: 5px;\n                        cursor: move;\n                    }\n                ",document.head.appendChild(style);var draggingElement=null;function handleDragStart(event){(draggingElement=event.target.closest("tr")).classList.add("dragging")}document.querySelectorAll(".drag-handle").forEach((function(element){element.addEventListener("dragstart",handleDragStart)})),tbody.addEventListener("dragover",(function(event){event.preventDefault()})),tbody.addEventListener("drop",(function(event){if(event.preventDefault(),draggingElement){var targetElement=event.target.closest("tr");if(targetElement&&targetElement!==draggingElement){var parent=draggingElement.parentNode;parent.removeChild(draggingElement);var referenceNode=targetElement.nextSibling&&targetElement.nextSibling.nodeType===Node.ELEMENT_NODE?targetElement.nextSibling:null;parent.insertBefore(draggingElement,referenceNode)}draggingElement.classList.remove("dragging"),draggingElement=null}})),tablaTitulo.insertAdjacentElement("afterend",table);var editarcrearTitulo=document.createElement("h3");editarcrearTitulo.textContent="Crear o editar H5P:",table.insertAdjacentElement("afterend",editarcrearTitulo);var h5pform=document.getElementsByTagName("form")[1];log.debug(h5pform);var buttonFin=document.createElement("button");buttonFin.setAttribute("id","finBtn"),buttonFin.textContent="Finalizar OA",buttonFin.addEventListener("click",(async function(){log.debug("CLICKED"),window.location.href="http://localhost/local/yourplugin/metadatos.php?courseid="+paramCourseid+"&oaid="+paramsObject.oaid})),h5pform.insertAdjacentElement("afterend",buttonFin);let draggedElement=null;document.querySelectorAll(".draggable").forEach((item=>{item.addEventListener("dragstart",(function(e){draggedElement=this,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",this.innerHTML)})),item.addEventListener("dragover",(function(e){return e.preventDefault&&e.preventDefault(),!1})),item.addEventListener("drop",(function(e){return e.stopPropagation&&e.stopPropagation(),draggedElement!==this&&(draggedElement.innerHTML=this.innerHTML,this.innerHTML=e.dataTransfer.getData("text/html")),!1}))}));var input=verboInput.querySelector("input");log.debug("verbo: ",input.value),setInterval((async function(){var input=verboInput.querySelector("input");resultadoAprendizajeOA.verbo=input.value,log.debug("resultadoAprendizajeOA:",resultadoAprendizajeOA.verbo);const saveChangesOnOntologyResponse=await(oaid=paramsObject.oaid,raoa=resultadoAprendizajeOA,contenidos=selectedTopics,actividades=[],metadatos=[],ajax.call([{methodname:"local_yourplugin_save_changes_automatically",args:{oaid:oaid,raoa:raoa,contenidos:contenidos,actividades:actividades,metadatos:metadatos}}])[0]);var oaid,raoa,contenidos,actividades,metadatos;log.debug(saveChangesOnOntologyResponse),log.debug("RUN saveChanges")}),15e4);var saveChangesButtonH5P=document.getElementById("id_submitbutton");log.debug("saveChangesButton:"+saveChangesButtonH5P),log.debug(saveChangesButtonH5P);var errorMessage=document.getElementById("error-message");errorMessage&&saveChangesButtonH5P.insertAdjacentElement("afterend",errorMessage)}))}}}));

//# sourceMappingURL=main.min.js.map